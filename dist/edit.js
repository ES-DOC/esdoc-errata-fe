!function(e){var t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(n,r,function(t){return e[t]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=3)}([function(e,t,i){"use strict";i.r(t),i.d(t,"COPYRIGHT_YEAR",function(){return n}),i.d(t,"FULLTITLE",function(){return r}),i.d(t,"LONG_NAME",function(){return s}),i.d(t,"NAME",function(){return a}),i.d(t,"ORGANIZATION",function(){return o}),i.d(t,"VERSION",function(){return u}),i.d(t,"events",function(){return d}),i.d(t,"log",function(){return l}),i.d(t,"on",function(){return c}),i.d(t,"trigger",function(){return p});const n=(new Date).getFullYear(),r="ES-DOC Dataset Errata",s="Dataset Errata",a="Errata",o="ES-DOC",u="0.6.4.0",d=_.extend({},Backbone.Events),l=e=>{console.log(new Date+" :: "+o+"-"+a.toUpperCase()+" :: "+e)},c=(e,t,i)=>{d.on(e,t,i)},p=(e,t)=>(l("event :: "+e),d.trigger(e,t))},function(e,t,i){"use strict";i.r(t);var n={};i.r(n),i.d(n,"CONTACT",function(){return a}),i.d(n,"SUPPORT",function(){return o}),i.d(n,"SUBJECT",function(){return u}),i.d(n,"MESSAGE",function(){return d});var r={};i.r(r),i.d(r,"LOGGING_PREFIX",function(){return l}),i.d(r,"NULL_FIELD",function(){return c}),i.d(r,"UI_UPDATE_DELAY",function(){return p});var s={};i.r(s),i.d(s,"API_BASE_URL",function(){return f}),i.d(s,"DOCUMENTATION",function(){return h}),i.d(s,"PIDDOCUMENTATION",function(){return g}),i.d(s,"HOME_PAGE",function(){return E}),i.d(s,"OAUTH_AUTHORIZE",function(){return v}),i.d(s,"PID_PAGE",function(){return m}),i.d(s,"PID_RESOLVE",function(){return S}),i.d(s,"PID_TASK_QUEUE_SEARCH",function(){return T}),i.d(s,"PID_TASK_QUEUE_SEARCH_SETUP",function(){return _}),i.d(s,"ISSUE_CREATE",function(){return A}),i.d(s,"ISSUE_UPDATE",function(){return U}),i.d(s,"RETRIEVE",function(){return D}),i.d(s,"SEARCH",function(){return I}),i.d(s,"SEARCH_SETUP",function(){return x}),i.d(s,"SEARCH_PAGE",function(){return O}),i.d(s,"VIEW_PAGE",function(){return b}),i.d(s,"EDIT_PAGE",function(){return w});const a="support@errata.es-doc.org",o="support@errata.es-doc.org",u="ES-DOC ERRATA :: subject goes here",d="Dear ES-DOC ERRATA support team,",l="ES-DOC-ERRATA :: ",c="--",p=1e3,f=window.origin,h="https://es-doc.github.io/esdoc-errata-client/",g="https://es-doc.github.io/esdoc-errata-client/lookup.html",E="https://es-doc.org",v=window.location.origin+"/oauth/authorize",m="pid.html",S="/1/resolve/pid",T="/1/pid-queue/search",_="/1/pid-queue/search-setup",A="/1/issue/create",U="/1/issue/update",D="/1/issue/retrieve",I="/1/issue/search",x="/1/issue/search-setup",O="/static/index.html",b="/static/view.html",w="/static/edit.html";i.d(t,"EMAIL",function(){return C}),i.d(t,"MISC",function(){return R}),i.d(t,"URLS",function(){return P});const C=n,R=r,P=s},function(e,t,i){"use strict";i.r(t),i.d(t,"openURL",function(){return s}),i.d(t,"openDocumentation",function(){return a}),i.d(t,"openPIDDocumentation",function(){return o}),i.d(t,"openHomepage",function(){return u}),i.d(t,"openEmail",function(){return d}),i.d(t,"openSupportEmail",function(){return l}),i.d(t,"render",function(){return c}),i.d(t,"renderHTML",function(){return p}),i.d(t,"renderTemplate",function(){return h}),i.d(t,"getURLParam",function(){return g}),i.d(t,"getPageCount",function(){return E}),i.d(t,"getPages",function(){return v}),i.d(t,"displayFeedback",function(){return m}),i.d(t,"hideFeedback",function(){return S}),i.d(t,"displayInfoDialog",function(){return T}),i.d(t,"hideInfoDialog",function(){return A}),i.d(t,"generateUUID",function(){return U});var n=i(0),r=i(1);const s=(e,t)=>{!0===t?window.open(e):window.location=e},a=()=>{s(r.URLS.DOCUMENTATION,!0)},o=()=>{s(r.URLS.PIDDOCUMENTATION,!0)},u=()=>{s(r.URLS.HOME_PAGE,!0)},d=(e,t,i)=>{var n="mailto:{0}?subject={1}&body={2}";t=t||r.EMAIL.SUBJECT,i=i||r.EMAIL.MESSAGE,n=(n=(n=n.replace("{0}",e)).replace("{1}",t)).replace("{2}",i),window.location.href=n},l=()=>{var e;e=(e=(e="ES-DOC :: SUPPORT :: {0} (v{1})").replace("{0}",n.NAME.toUpperCase())).replace("{1}",n.VERSION),d(r.EMAIL.SUPPORT,e)},c=(e,t,i)=>{var n,r,s=[];return n=_.isArray(e)?e:[e],_.each(n,function(e){r=new e(t).render(),s.push(r),_.isUndefined(i)||(_.has(i,"$el")?i.$el.append(r.$el):i.append(r.$el))},void 0),1===n.length?s[0]:s},p=(e,t,i)=>{var n=t?e(t):e();_.isUndefined(i)||(_.has(i,"$el")?i.$el.append(n):i.append(n))},f={},h=(e,t,i)=>{var n;if(_.has(f,e)||(f[e]=_.template($("#"+e).html())),n=(0,f[e])(t),i&&i.$el)i.$el.append(n);else{if(!i)return n;i.replaceWith(n)}},g=(e,t)=>{var i=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(window.location.href);return i?(i[1]||t).toUpperCase():t},E=function(e,t){var i=0;return t&&t/e>(i=parseInt(t/e,10))&&(i+=1),i},v=(e,t)=>_.map(_.range(E(e,t.length)),function(t){return{id:t+1,data:this.slice(t*e,(t+1)*e-1)}},t),m=e=>{$("#feedbackText").text(e+" ... please wait"),$(".feedback-title").text(n.FULLTITLE),$(".feedback-version").text("v"+n.VERSION),$("#feedbackContainer").modal({backdrop:"static",keyboard:!1,show:!0})},S=()=>{$("#feedbackContainer").modal("hide")},T=(e,t)=>{$("#infoDialogText").text(e),$(".infoDialog-title").text(n.FULLTITLE),$(".infoDialog-version").text("v"+n.VERSION),t&&$("#infoDialogContainer").on("hide.bs.modal",t),$("#infoDialogContainer").modal({backdrop:"static",keyboard:!1,show:!0})},A=()=>{$("#infoDialog").modal("hide")},U=()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)})}},function(e,t,i){"use strict";i.r(t);var n={};i.r(n),i.d(n,"OAuthCredentials",function(){return o}),i.d(n,"isAuthenticated",function(){return u}),i.d(n,"issue",function(){return d});var r=i(0),s=i(2),a=i(1);const o=Cookies.get("errata-oauth-credentials"),u=!1===_.isUndefined(o),d=new class{constructor(){this.datasets=[],this.description=null,this.materials=[],this.project=null,this.status="new",this.title=null,this.uid=s.getURLParam("uid")||s.generateUUID(),this.isNew=!s.getURLParam("uid"),this.urls=[],this.setHash()}get fullTitle(){if(this.isNew)return"New Issue";let e;return e=this.project.toUpperCase(),e+=" - ",e+=this.title.slice(0,48),this.title.length>48&&(e+="..."),e}get hasChanged(){return this.stateHash!==this.encode()}setHash(){this.stateHash=this.encode()}decode(e){this.datasets=e.datasets,this.description=e.description,this.materials=e.materials,this.project=e.project,this.severity=e.severity,this.status=e.status,this.title=e.title,this.uid=e.uid,this.urls=e.urls}encode(){return JSON.stringify({datasets:this.datasets,description:this.description,materials:this.materials,project:this.project,severity:this.severity,status:this.status,title:this.title,uid:this.uid,urls:this.urls})}};r.on("field:change:aborted",e=>{d[e.id]=_.isArray(e.value)?[]:null}),r.on("field:change:verified",e=>{d[e.id]=e.value}),r.on("issue:save:start",()=>{d.hasChanged?r.trigger("issue:save:post"):r.trigger("issue:save:abort")});const l="Required field - you must enter a value.";validate.validators.presence.options={message:l},validate.validators.materialsValidator=function(e){if(0===e.length)return;const t=["jpg","gif","png","tiff"];return _.filter(e,e=>_.isObject(validate({field:e},{field:{url:!0}}))||!1===_.contains(t,_.last(e.split(".")))).length>0?"Must be a list of valid image file links (.jpg, .gif, .png, .tiff).":void 0},validate.validators.urlsValidator=function(e){if(0!==e.length)return _.filter(e,e=>_.isObject(validate({field:e},{field:{url:!0}}))).length>0?"Must be a list of valid links.":void 0},validate.validators.datasetsValidator=function(e){if(0===e.length)return l;console.log("TODO: Check datasets prefixed with project code"),console.log("TODO: POST datasets to server for validation")};const c={project:{presence:!0,inclusion:{within:["cmip5","cmip6","cordex"],message:l}},title:{presence:!0,length:{minimum:16,maximum:255,message:"Must be 16 to 255 characters."}},description:{presence:!0,length:{minimum:16,maximum:1023,message:"Must be 16 to 1023 characters."}},severity:{presence:!0,inclusion:{within:["low","medium","high","critical"],message:l}},status:{presence:!0,inclusion:{within:["new","onhold","resolved","wontfix"],message:l}},urls:{urlsValidator:{}},materials:{materialsValidator:{}},datasets:{datasetsValidator:{}}};r.on("field:change",e=>{const t={},i={};t[e.id]=""===e.value?null:e.value,i[e.id]=c[e.id];const n=validate(t,i,{fullMessages:!1});n?(e.err=n[e.id][0],r.trigger("field:change:aborted",e)):r.trigger("field:change:verified",e)});const p=["project","title","description","severity","urls","materials","datasets"],f=["description","severity","status","urls","materials","datasets"];var h=Backbone.View.extend({events:{"click img.esdoc-logo":function(e){s.openHomepage()},"click button.esdoc-support":function(e){s.openSupportEmail()},"click button.esdoc-docs":()=>{s.openDocumentation()},"click button.esdoc-errata-save":function(e){const t=d.isNew?p:f;_.each(t,this.setFieldValue,this),$(".field-value").hasClass("has-error")?r.trigger("issue:save:invalidated"):r.trigger("issue:save:start")},"change .form-control":function(e){this.setFieldValue($(e.target).attr("id"))}},initialize:function(){r.on("field:change:aborted",this._onFieldChange,this),r.on("field:change:verified",this._onFieldChange,this)},render:function(){return s.renderTemplate("template-header",null,this),s.renderTemplate("template-issue",null,this),this},setFieldValue:function(e){console.log(e);let t=$("#"+e).val().trim();_.contains(["urls","materials","datasets"],e)&&(t=t.split("\n"),t=_.map(t,e=>e.trim()),t=_.uniq(t),t=_.filter(t,e=>e.length>0)),r.trigger("field:change",{id:e,value:t})},_onFieldChange:function(e){e.err?(this.$("."+e.id).addClass("has-error"),this.$("#"+e.id+"ErrorMessage").text(e.err)):(this.$("."+e.id).removeClass("has-error"),this.$("#"+e.id+"ErrorMessage").text(""))}});r.on("setup:begin",()=>{var e,t;d.isNew?r.trigger("setup:complete"):(e=a.URLS.API_BASE_URL+a.URLS.RETRIEVE,t={uid:d.uid},$.get(e,t).done(e=>{setTimeout(()=>{r.trigger("setup:issueDownload",e)},a.MISC.UI_UPDATE_DELAY)}).fail(()=>{setTimeout(()=>{r.trigger("setup:issueDownload:error")},a.MISC.UI_UPDATE_DELAY)}))}),r.on("setup:issueDownload",e=>{d.decode(e.issue),r.trigger("setup:complete")}),r.on("setup:issueDownload:error",e=>{alert("TODO: handle issue download error")}),r.on("setup:begin",()=>{s.displayFeedback("Initializing errata editor")}),r.on("setup:complete",()=>{setTimeout(()=>{s.hideFeedback()},a.MISC.UI_UPDATE_DELAY)}),r.on("setup:setupDataDownload:error",()=>{alert("TODO: setup:setupDataDownload:error")}),r.on("issue:save:invalidated",()=>{s.displayInfoDialog("Issue is invalid - please correct errors & try again.")}),r.on("issue:save:post:starts",()=>{s.displayFeedback("Saving issue details")}),r.on("issue:save:post:success",()=>{s.hideFeedback(),s.displayInfoDialog("Issue details have been successfully saved.",()=>{r.trigger("issue:save:complete")})}),r.on("issue:save:post:error",()=>{s.hideFeedback(),s.displayInfoDialog("An error occurred whilst saving the issue details - please try again.  If the problem persists then contact support.")}),r.on("issue:save:post",()=>{const e=CONSTANTS.URLS.API_BASE_URL+(d.isNew?CONSTANTS.URLS.ISSUE_CREATE:CONSTANTS.URLS.ISSUE_UPDATE);r.trigger("issue:save:post:starts"),$.ajax({method:"POST",url:e,data:d.encode(),dataType:"json",headers:{Authorization:o,"Content-Type":"application/json; charset=UTF-8","X-XSRFToken":Cookies.get("_xsrf")}}).always(e=>{200===e.status?r.trigger("issue:save:post:success"):r.trigger("issue:save:post:error",e)})}),$(document).ready(()=>{PYESSV.initialise(()=>{r.trigger("setup:begin")})}),r.on("setup:complete",()=>{var e;(e=new h).render(),$("body").append(e.el),r.trigger("ui:initialized")}),r.on("issue:save:complete",()=>{let e=a.URLS.VIEW_PAGE;e+="?uid=",e+=d.uid,s.openURL(e)}),window.APP=r,window.CONSTANTS=a,window.STATE=n,window.UTILS=s}]);